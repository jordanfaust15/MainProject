<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'">
  <title>Reentry</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #1a1a2e;
      --surface: #16213e;
      --surface-alt: #0f3460;
      --primary: #e94560;
      --primary-hover: #ff6b6b;
      --text: #eaeaea;
      --text-muted: #a0a0b0;
      --success: #4ecdc4;
      --warning: #f9c74f;
      --border: #2a2a4a;
      --radius: 8px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #app {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
    }

    /* ── Header ──────────────────────────────── */
    .header {
      text-align: center;
      padding: 12px 0 16px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 1px;
    }

    .header .subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ── Navigation ──────────────────────────── */
    .nav {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .nav button {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav button:hover {
      background: var(--surface-alt);
    }

    .nav button.active {
      background: var(--primary);
      border-color: var(--primary);
      font-weight: 600;
    }

    /* ── Sections ────────────────────────────── */
    .section {
      display: none;
      flex-direction: column;
      gap: 12px;
      flex: 1;
    }

    .section.active {
      display: flex;
    }

    /* ── Project selector ────────────────────── */
    .project-input {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .project-input input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 14px;
    }

    .project-input input::placeholder {
      color: var(--text-muted);
    }

    /* ── Capture area ────────────────────────── */
    .capture-area {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
    }

    .capture-area textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
      font-family: inherit;
    }

    .capture-area textarea::placeholder {
      color: var(--text-muted);
    }

    .capture-area textarea:focus {
      outline: none;
      border-color: var(--primary);
    }

    .capture-controls {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      align-items: center;
    }

    .timer {
      font-size: 13px;
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }

    .timer.urgent {
      color: var(--primary);
      font-weight: 600;
    }

    /* ── Buttons ──────────────────────────────── */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--surface-alt);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-small {
      padding: 6px 14px;
      font-size: 12px;
    }

    /* ── Briefing card ────────────────────────── */
    .briefing-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .briefing-header {
      background: var(--surface-alt);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .briefing-header h2 {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .briefing-header .time-away {
      font-size: 13px;
      color: var(--text-muted);
    }

    .briefing-body {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .briefing-element {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .briefing-element .label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .briefing-element .label.intent { color: var(--primary); }
    .briefing-element .label.last-action { color: var(--success); }
    .briefing-element .label.open-loops { color: var(--warning); }
    .briefing-element .label.next-action { color: #7ec8e3; }

    .briefing-element .value {
      font-size: 14px;
      line-height: 1.4;
    }

    .briefing-element .value li {
      list-style: none;
      padding: 2px 0;
    }

    .briefing-element .value li::before {
      content: '- ';
      color: var(--text-muted);
    }

    .no-capture {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
    }

    .no-capture .icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .missing-elements {
      font-size: 12px;
      color: var(--text-muted);
      padding: 8px 16px;
      border-top: 1px solid var(--border);
    }

    .reconstruction-tip {
      font-size: 12px;
      color: var(--text-muted);
      padding: 8px 16px;
      background: rgba(249, 199, 79, 0.1);
      border-top: 1px solid var(--border);
    }

    /* ── Feedback ─────────────────────────────── */
    .feedback {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
    }

    .feedback span {
      font-size: 12px;
      color: var(--text-muted);
      margin-right: auto;
    }

    .feedback button {
      padding: 4px 12px;
      border: 1px solid var(--border);
      border-radius: 4px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .feedback button:hover {
      border-color: var(--primary);
    }

    .feedback button.selected {
      background: var(--primary);
      border-color: var(--primary);
    }

    .feedback .confirmed {
      font-size: 12px;
      color: var(--success);
    }

    /* ── Status messages ──────────────────────── */
    .status {
      font-size: 13px;
      padding: 10px 14px;
      border-radius: var(--radius);
      margin-top: 8px;
    }

    .status.success {
      background: rgba(78, 205, 196, 0.15);
      color: var(--success);
      border: 1px solid rgba(78, 205, 196, 0.3);
    }

    .status.error {
      background: rgba(233, 69, 96, 0.15);
      color: var(--primary);
      border: 1px solid rgba(233, 69, 96, 0.3);
    }

    .status.info {
      background: rgba(126, 200, 227, 0.15);
      color: #7ec8e3;
      border: 1px solid rgba(126, 200, 227, 0.3);
    }

    /* ── Empty state ──────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state h3 {
      font-size: 16px;
      margin-bottom: 8px;
      color: var(--text);
    }

    .empty-state p {
      font-size: 13px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="header">
      <h1>REENTRY</h1>
      <div class="subtitle">Personal Restart Assistant</div>
    </div>

    <div class="project-input">
      <input type="text" id="project-id" placeholder="Project name..." value="default">
    </div>

    <div class="nav">
      <button id="nav-briefing" class="active" onclick="showSection('briefing')">Briefing</button>
      <button id="nav-capture" onclick="showSection('capture')">Quick Capture</button>
      <button id="nav-history" onclick="showSection('history')">History</button>
    </div>

    <!-- Briefing Section -->
    <div id="section-briefing" class="section active">
      <div id="briefing-content">
        <div class="empty-state">
          <h3>No sessions yet</h3>
          <p>Start a session and make a capture to see your restart briefing here.</p>
        </div>
      </div>
      <div style="display: flex; gap: 8px; margin-top: auto;">
        <button class="btn btn-primary" style="flex:1" onclick="startSession()">Start Session</button>
        <button class="btn btn-secondary" style="flex:1" onclick="loadBriefing()">Refresh</button>
      </div>
    </div>

    <!-- Capture Section -->
    <div id="section-capture" class="section">
      <div class="capture-area">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <span style="font-size: 13px; font-weight: 600;">What were you working on?</span>
          <span id="capture-timer" class="timer"></span>
        </div>
        <textarea id="capture-text" placeholder="I was working on... Found that... Need to check... Next I should..."></textarea>
        <div class="capture-controls">
          <button class="btn btn-primary" onclick="submitCapture()">Save Capture</button>
          <button class="btn btn-secondary btn-small" onclick="startInterrupt()">Interrupt (2s)</button>
        </div>
      </div>
      <div id="capture-status"></div>
    </div>

    <!-- History Section -->
    <div id="section-history" class="section">
      <div id="history-content">
        <div class="empty-state">
          <h3>No history</h3>
          <p>Session history will appear here once you start working.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ── State ─────────────────────────────────────────────────
    let currentSessionId = null;
    let currentCaptureSession = null;
    let captureTimerInterval = null;

    // ── Navigation ────────────────────────────────────────────
    function showSection(name) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
      document.getElementById('section-' + name).classList.add('active');
      document.getElementById('nav-' + name).classList.add('active');

      if (name === 'briefing') loadBriefing();
      if (name === 'history') loadHistory();
    }

    // ── Session management ────────────────────────────────────
    async function startSession() {
      const projectId = document.getElementById('project-id').value || 'default';
      try {
        const session = await window.reentryAPI.createSession(projectId);
        currentSessionId = session.id;
        showStatus('briefing-content',
          'Session started for "' + projectId + '"', 'success');
      } catch (err) {
        showStatus('briefing-content', 'Failed to start session: ' + err.message, 'error');
      }
    }

    async function loadBriefing() {
      const projectId = document.getElementById('project-id').value || 'default';
      const container = document.getElementById('briefing-content');

      try {
        const briefing = await window.reentryAPI.generateBriefingForProject(projectId);
        if (!briefing) {
          container.innerHTML = '<div class="empty-state"><h3>No sessions yet</h3>' +
            '<p>Start a session and make a capture to see your restart briefing here.</p></div>';
          return;
        }

        currentSessionId = briefing.sessionId;
        container.innerHTML = renderBriefingCard(briefing);
      } catch (err) {
        showStatus('briefing-content', 'Failed to load briefing: ' + err.message, 'error');
      }
    }

    // ── Capture ───────────────────────────────────────────────
    async function submitCapture() {
      const text = document.getElementById('capture-text').value.trim();
      if (!text) return;

      const projectId = document.getElementById('project-id').value || 'default';

      try {
        // Ensure we have a session
        if (!currentSessionId) {
          const session = await window.reentryAPI.createSession(projectId);
          currentSessionId = session.id;
        }

        // Start quick capture
        const capSession = await window.reentryAPI.startQuickCapture(currentSessionId);
        const result = await window.reentryAPI.submitTextCapture(capSession.id, text);

        if (result.success) {
          document.getElementById('capture-text').value = '';
          stopCaptureTimer();
          showStatus('capture-status', 'Capture saved! Context extracted.', 'success');
          currentSessionId = null; // Session is closed after capture
        } else {
          showStatus('capture-status', 'Capture failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (err) {
        showStatus('capture-status', 'Error: ' + err.message, 'error');
      }
    }

    async function startInterrupt() {
      const projectId = document.getElementById('project-id').value || 'default';

      try {
        if (!currentSessionId) {
          const session = await window.reentryAPI.createSession(projectId);
          currentSessionId = session.id;
        }

        const capSession = await window.reentryAPI.startInterruptCapture(currentSessionId);
        const text = document.getElementById('capture-text').value.trim() || 'Quick interrupt - no details captured';
        const result = await window.reentryAPI.submitTextCapture(capSession.id, text);

        if (result.success) {
          document.getElementById('capture-text').value = '';
          showStatus('capture-status', 'Interrupt capture saved!', 'success');
          currentSessionId = null;
        }
      } catch (err) {
        showStatus('capture-status', 'Error: ' + err.message, 'error');
      }
    }

    function startCaptureTimer(seconds) {
      const timerEl = document.getElementById('capture-timer');
      let remaining = seconds;

      function update() {
        timerEl.textContent = remaining + 's';
        timerEl.className = remaining <= 10 ? 'timer urgent' : 'timer';
        remaining--;
        if (remaining < 0) {
          stopCaptureTimer();
          submitCapture(); // Auto-submit on timeout
        }
      }

      update();
      captureTimerInterval = setInterval(update, 1000);
    }

    function stopCaptureTimer() {
      if (captureTimerInterval) {
        clearInterval(captureTimerInterval);
        captureTimerInterval = null;
      }
      document.getElementById('capture-timer').textContent = '';
    }

    // ── History ───────────────────────────────────────────────
    async function loadHistory() {
      const projectId = document.getElementById('project-id').value || 'default';
      const container = document.getElementById('history-content');

      try {
        const history = await window.reentryAPI.getSessionHistory(projectId);
        if (!history || history.length === 0) {
          container.innerHTML = '<div class="empty-state"><h3>No history</h3>' +
            '<p>Session history will appear here once you start working.</p></div>';
          return;
        }

        container.innerHTML = history.map(function(session) {
          const entry = new Date(session.entryTime).toLocaleString();
          const exit = session.exitTime ? new Date(session.exitTime).toLocaleString() : 'Active';
          const feedback = session.feedbackRating ? ' | Rating: ' + session.feedbackRating + '/5' : '';
          return '<div class="capture-area" style="padding: 10px 14px;">' +
            '<div style="font-size: 13px; font-weight: 600;">Session ' + session.id.slice(0, 8) + '</div>' +
            '<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">' +
            'Entry: ' + entry + '<br>Exit: ' + exit + feedback +
            '</div></div>';
        }).join('');
      } catch (err) {
        showStatus('history-content', 'Failed to load history: ' + err.message, 'error');
      }
    }

    // ── Briefing card rendering ───────────────────────────────
    function renderBriefingCard(briefing) {
      let html = '<div class="briefing-card">';
      html += '<div class="briefing-header">';
      html += '<h2>RESTART BRIEFING</h2>';
      html += '<span class="time-away">Away: ' + briefing.timeAway.formatted + '</span>';
      html += '</div>';
      html += '<div class="briefing-body">';

      if (!briefing.hasCapture) {
        html += '<div class="no-capture">';
        html += '<div class="icon">?</div>';
        html += '<div>No capture available for this session.</div>';
        html += '</div>';
      } else {
        if (briefing.intent) {
          html += renderElement('Intent', 'intent', briefing.intent);
        }
        if (briefing.lastAction) {
          html += renderElement('Last Action', 'last-action', briefing.lastAction);
        }
        if (briefing.openLoops) {
          html += renderElement('Open Loops', 'open-loops', briefing.openLoops);
        }
        if (briefing.nextAction) {
          html += renderElement('Next Action', 'next-action', briefing.nextAction);
        }
      }

      html += '</div>'; // briefing-body

      if (briefing.missingElements && briefing.missingElements.length > 0) {
        html += '<div class="missing-elements">Missing: ' +
          briefing.missingElements.join(', ') + '</div>';
      }

      if (briefing.reconstructionGuidance) {
        html += '<div class="reconstruction-tip">Tip: ' +
          briefing.reconstructionGuidance + '</div>';
      }

      // Feedback
      html += '<div class="feedback" id="feedback-area">';
      html += '<span>Was this helpful?</span>';
      for (let i = 1; i <= 5; i++) {
        html += '<button onclick="sendFeedback(\'' + briefing.sessionId + '\', ' + i + ')">' + i + '</button>';
      }
      html += '</div>';

      html += '</div>'; // briefing-card
      return html;
    }

    function renderElement(label, className, items) {
      let html = '<div class="briefing-element">';
      html += '<div class="label ' + className + '">' + label + '</div>';
      html += '<div class="value"><ul>';
      items.forEach(function(item) {
        html += '<li>' + escapeHtml(item) + '</li>';
      });
      html += '</ul></div></div>';
      return html;
    }

    // ── Feedback ──────────────────────────────────────────────
    async function sendFeedback(sessionId, rating) {
      try {
        await window.reentryAPI.submitFeedback(sessionId, rating);
        const area = document.getElementById('feedback-area');
        area.innerHTML = '<span class="confirmed">Thanks for your feedback!</span>';
      } catch (err) {
        // Silent failure for feedback
      }
    }

    // ── Helpers ───────────────────────────────────────────────
    function showStatus(containerId, message, type) {
      const container = document.getElementById(containerId);
      const statusHtml = '<div class="status ' + type + '">' + escapeHtml(message) + '</div>';

      if (containerId === 'capture-status') {
        container.innerHTML = statusHtml;
      } else {
        container.insertAdjacentHTML('afterbegin', statusHtml);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ── Interrupt capture shortcut listener ───────────────────
    if (window.reentryAPI) {
      window.reentryAPI.onInterruptCaptureTrigger(function() {
        showSection('capture');
        startCaptureTimer(2);
        document.getElementById('capture-text').focus();
      });
    }
  </script>
</body>
</html>
